import{e as ie,a_ as Le,a$ as me,bV as be,a8 as ue,bR as se,al as de,c4 as Ie,bU as ge,bT as ye,d as ce,bL as Ee,bP as De,b as Me,aP as he,bJ as Ve,G as fe,bC as we,Z as Se,N as x,dz as Te,a5 as Ne}from"./index-B7p1rSoh.js";import{l as Ge}from"./createGraphFromNodeEdge-hDOu6_cZ.js";import{D as ke}from"./VisualMapping-CR3SKxGR.js";import"./linkSeriesData-DMzrFD1S.js";var je=function(){this.x1=0,this.y1=0,this.x2=0,this.y2=0,this.cpx1=0,this.cpy1=0,this.cpx2=0,this.cpy2=0,this.extent=0},Ae=function(o){function a(e){return o.call(this,e)||this}return ie(a,o),a.prototype.getDefaultShape=function(){return new je},a.prototype.buildPath=function(e,n){var t=n.extent;e.moveTo(n.x1,n.y1),e.bezierCurveTo(n.cpx1,n.cpy1,n.cpx2,n.cpy2,n.x2,n.y2),n.orient==="vertical"?(e.lineTo(n.x2+t,n.y2),e.bezierCurveTo(n.cpx2+t,n.cpy2,n.cpx1+t,n.cpy1,n.x1+t,n.y1)):(e.lineTo(n.x2,n.y2+t),e.bezierCurveTo(n.cpx2,n.cpy2+t,n.cpx1,n.cpy1+t,n.x1,n.y1+t)),e.closePath()},a.prototype.highlight=function(){Le(this)},a.prototype.downplay=function(){me(this)},a}(be);function pe(o,a,e){switch(o.fill){case"source":o.fill=e.node1.getVisual("color"),o.decal=e.node1.getVisual("style").decal;break;case"target":o.fill=e.node2.getVisual("color"),o.decal=e.node2.getVisual("style").decal;break;case"gradient":var n=e.node1.getVisual("color"),t=e.node2.getVisual("color");fe(n)&&fe(t)&&(o.fill=new we(0,0,+(a==="horizontal"),+(a==="vertical"),[{color:n,offset:0},{color:t,offset:1}]))}}var Pe=function(o){function a(){var e=o!==null&&o.apply(this,arguments)||this;return e.type=a.type,e._focusAdjacencyDisabled=!1,e}return ie(a,o),a.prototype.render=function(e,n,t){var u=this,d=e.getGraph(),l=this.group,i=e.layoutInfo,c=i.width,L=i.height,g=e.getData(),p=e.getData("edge"),v=e.get("orient");this._model=e,l.removeAll(),l.x=i.x,l.y=i.y,d.eachEdge(function(r){var s=new Ae,h=ue(s);h.dataIndex=r.dataIndex,h.seriesIndex=e.seriesIndex,h.dataType="edge";var T,P,F,y,G,m,V,w,E=r.getModel(),b=E.getModel("lineStyle"),I=b.get("curveness"),z=r.node1.getLayout(),C=r.node1.getModel(),_=C.get("localX"),k=C.get("localY"),f=r.node2.getLayout(),j=r.node2.getModel(),S=j.get("localX"),D=j.get("localY"),M=r.getLayout();s.shape.extent=Math.max(1,M.dy),s.shape.orient=v,v==="vertical"?(T=(_!=null?_*c:z.x)+M.sy,P=(k!=null?k*L:z.y)+z.dy,F=(S!=null?S*c:f.x)+M.ty,G=T,m=P*(1-I)+(y=D!=null?D*L:f.y)*I,V=F,w=P*I+y*(1-I)):(T=(_!=null?_*c:z.x)+z.dx,P=(k!=null?k*L:z.y)+M.sy,G=T*(1-I)+(F=S!=null?S*c:f.x)*I,m=P,V=T*I+F*(1-I),w=y=(D!=null?D*L:f.y)+M.ty),s.setShape({x1:T,y1:P,x2:F,y2:y,cpx1:G,cpy1:m,cpx2:V,cpy2:w}),s.useStyle(b.getItemStyle()),pe(s.style,v,r);var N=""+E.get("value"),A=se(E,"edgeLabel");de(s,A,{labelFetcher:{getFormattedLabel:function(U,H,Z,q,Q,Y){return e.getFormattedLabel(U,H,"edge",q,Ie(Q,A.normal&&A.normal.get("formatter"),N),Y)}},labelDataIndex:r.dataIndex,defaultText:N}),s.setTextConfig({position:"inside"});var B=E.getModel("emphasis");ge(s,E,"lineStyle",function(U){var H=U.getItemStyle();return pe(H,v,r),H}),l.add(s),p.setItemGraphicEl(r.dataIndex,s);var X=B.get("focus");ye(s,X==="adjacency"?r.getAdjacentDataIndices():X==="trajectory"?r.getTrajectoryDataIndices():X,B.get("blurScope"),B.get("disabled"))}),d.eachNode(function(r){var s=r.getLayout(),h=r.getModel(),T=h.get("localX"),P=h.get("localY"),F=h.getModel("emphasis"),y=new ce({shape:{x:T!=null?T*c:s.x,y:P!=null?P*L:s.y,width:s.dx,height:s.dy},style:h.getModel("itemStyle").getItemStyle(),z2:10});de(y,se(h),{labelFetcher:{getFormattedLabel:function(m,V){return e.getFormattedLabel(m,V,"node")}},labelDataIndex:r.dataIndex,defaultText:r.id}),y.disableLabelAnimation=!0,y.setStyle("fill",r.getVisual("color")),y.setStyle("decal",r.getVisual("style").decal),ge(y,h),l.add(y),g.setItemGraphicEl(r.dataIndex,y),ue(y).dataType="node";var G=F.get("focus");ye(y,G==="adjacency"?r.getAdjacentDataIndices():G==="trajectory"?r.getTrajectoryDataIndices():G,F.get("blurScope"),F.get("disabled"))}),g.eachItemGraphicEl(function(r,s){g.getItemModel(s).get("draggable")&&(r.drift=function(h,T){u._focusAdjacencyDisabled=!0,this.shape.x+=h,this.shape.y+=T,this.dirty(),t.dispatchAction({type:"dragNode",seriesId:e.id,dataIndex:g.getRawIndex(s),localX:this.shape.x/c,localY:this.shape.y/L})},r.ondragend=function(){u._focusAdjacencyDisabled=!1},r.draggable=!0,r.cursor="move")}),!this._data&&e.isAnimationEnabled()&&l.setClipPath(function(r,s,h){var T=new ce({shape:{x:r.x-10,y:r.y-10,width:0,height:r.height+20}});return Ee(T,{shape:{width:r.width+20}},s,h),T}(l.getBoundingRect(),e,function(){l.removeClipPath()})),this._data=e.getData()},a.prototype.dispose=function(){},a.type="sankey",a}(De),ze=function(o){function a(){var e=o!==null&&o.apply(this,arguments)||this;return e.type=a.type,e}return ie(a,o),a.prototype.getInitialData=function(e,n){var t=e.edges||e.links,u=e.data||e.nodes,d=e.levels;this.levelModels=[];for(var l=this.levelModels,i=0;i<d.length;i++)d[i].depth!=null&&d[i].depth>=0&&(l[d[i].depth]=new Me(d[i],this,n));if(u&&t)return Ge(u,t,this,!0,function(c,L){c.wrapMethod("getItemModel",function(g,p){var v=g.parentModel,r=v.getData().getItemLayout(p);if(r){var s=r.depth,h=v.levelModels[s];h&&(g.parentModel=h)}return g}),L.wrapMethod("getItemModel",function(g,p){var v=g.parentModel,r=v.getGraph().getEdgeByIndex(p).node1.getLayout();if(r){var s=r.depth,h=v.levelModels[s];h&&(g.parentModel=h)}return g})}).data},a.prototype.setNodePosition=function(e,n){var t=(this.option.data||this.option.nodes)[e];t.localX=n[0],t.localY=n[1]},a.prototype.getGraph=function(){return this.getData().graph},a.prototype.getEdgeData=function(){return this.getGraph().edgeData},a.prototype.formatTooltip=function(e,n,t){function u(p){return isNaN(p)||p==null}if(t==="edge"){var d=this.getDataParams(e,t),l=d.data,i=d.value,c=l.source+" -- "+l.target;return he("nameValue",{name:c,value:i,noValue:u(i)})}var L=this.getGraph().getNodeByIndex(e).getLayout().value,g=this.getDataParams(e,t).data.name;return he("nameValue",{name:g!=null?g+"":null,value:L,noValue:u(L)})},a.prototype.optionUpdated=function(){},a.prototype.getDataParams=function(e,n){var t=o.prototype.getDataParams.call(this,e,n);if(t.value==null&&n==="node"){var u=this.getGraph().getNodeByIndex(e).getLayout().value;t.value=u}return t},a.type="series.sankey",a.defaultOption={z:2,coordinateSystem:"view",left:"5%",top:"5%",right:"20%",bottom:"5%",orient:"horizontal",nodeWidth:20,nodeGap:8,draggable:!0,layoutIterations:32,label:{show:!0,position:"right",fontSize:12},edgeLabel:{show:!1,fontSize:12},levels:[],nodeAlign:"justify",lineStyle:{color:"#314656",opacity:.2,curveness:.5},emphasis:{label:{show:!0},lineStyle:{opacity:.5}},select:{itemStyle:{borderColor:"#212121"}},animationEasing:"linear",animationDuration:1e3},a}(Ve);function Ce(o,a){o.eachSeriesByType("sankey",function(e){var n=e.get("nodeWidth"),t=e.get("nodeGap"),u=function(g,p){return Se(g.getBoxLayoutParams(),{width:p.getWidth(),height:p.getHeight()})}(e,a);e.layoutInfo=u;var d=u.width,l=u.height,i=e.getGraph(),c=i.nodes,L=i.edges;(function(g){x(g,function(p){var v=O(p.outEdges,$),r=O(p.inEdges,$),s=p.getValue()||0,h=Math.max(v,r,s);p.setLayout({value:h},!0)})})(c),function(g,p,v,r,s,h,T,P,F){(function(y,G,m,V,w,E,b){for(var I=[],z=[],C=[],_=[],k=0,f=0;f<G.length;f++)I[f]=1;for(f=0;f<y.length;f++)z[f]=y[f].inEdges.length,z[f]===0&&C.push(y[f]);for(var j=-1;C.length;){for(var S=0;S<C.length;S++){var D=C[S],M=D.hostGraph.data.getRawDataItem(D.dataIndex),N=M.depth!=null&&M.depth>=0;N&&M.depth>j&&(j=M.depth),D.setLayout({depth:N?M.depth:k},!0),E==="vertical"?D.setLayout({dy:m},!0):D.setLayout({dx:m},!0);for(var A=0;A<D.outEdges.length;A++){var B=D.outEdges[A];I[G.indexOf(B)]=0;var X=B.node2;--z[y.indexOf(X)]==0&&_.indexOf(X)<0&&_.push(X)}}++k,C=_,_=[]}for(f=0;f<I.length;f++)if(I[f]===1)throw new Error("Sankey is a DAG, the original data has cycle!");var U=j>k-1?j:k-1;b&&b!=="left"&&function(Z,q,Q,Y){if(q==="right"){for(var W=[],K=Z,re=0;K.length;){for(var ee=0;ee<K.length;ee++){var te=K[ee];te.setLayout({skNodeHeight:re},!0);for(var ae=0;ae<te.inEdges.length;ae++){var le=te.inEdges[ae];W.indexOf(le.node1)<0&&W.push(le.node1)}}K=W,W=[],++re}x(Z,function(J){ve(J)||J.setLayout({depth:Math.max(0,Y-J.getLayout().skNodeHeight)},!0)})}else q==="justify"&&function(J,xe){x(J,function(oe){ve(oe)||oe.outEdges.length||oe.setLayout({depth:xe},!0)})}(Z,Y)}(y,b,0,U);var H=E==="vertical"?(w-m)/U:(V-m)/U;(function(Z,q,Q){x(Z,function(Y){var W=Y.getLayout().depth*q;Q==="vertical"?Y.setLayout({y:W},!0):Y.setLayout({x:W},!0)})})(y,H,E)})(g,p,v,s,h,P,F),function(y,G,m,V,w,E,b){var I=function(C,_){var k=[],f=_==="vertical"?"y":"x",j=Te(C,function(S){return S.getLayout()[f]});return j.keys.sort(function(S,D){return S-D}),x(j.keys,function(S){k.push(j.buckets.get(S))}),k}(y,b);(function(C,_,k,f,j,S){var D=1/0;x(C,function(M){var N=M.length,A=0;x(M,function(X){A+=X.getLayout().value});var B=S==="vertical"?(f-(N-1)*j)/A:(k-(N-1)*j)/A;B<D&&(D=B)}),x(C,function(M){x(M,function(N,A){var B=N.getLayout().value*D;S==="vertical"?(N.setLayout({x:A},!0),N.setLayout({dx:B},!0)):(N.setLayout({y:A},!0),N.setLayout({dy:B},!0))})}),x(_,function(M){var N=+M.getValue()*D;M.setLayout({dy:N},!0)})})(I,G,m,V,w,b),ne(I,w,m,V,b);for(var z=1;E>0;E--)_e(I,z*=.99,b),ne(I,w,m,V,b),Oe(I,z,b),ne(I,w,m,V,b)}(g,p,h,s,r,T,P),function(y,G){var m=G==="vertical"?"x":"y";x(y,function(V){V.outEdges.sort(function(w,E){return w.node2.getLayout()[m]-E.node2.getLayout()[m]}),V.inEdges.sort(function(w,E){return w.node1.getLayout()[m]-E.node1.getLayout()[m]})}),x(y,function(V){var w=0,E=0;x(V.outEdges,function(b){b.setLayout({sy:w},!0),w+=b.getLayout().dy}),x(V.inEdges,function(b){b.setLayout({ty:E},!0),E+=b.getLayout().dy})})}(g,P)}(c,L,n,t,d,l,Ne(c,function(g){return g.getLayout().value===0}).length!==0?0:e.get("layoutIterations"),e.get("orient"),e.get("nodeAlign"))})}function ve(o){var a=o.hostGraph.data.getRawDataItem(o.dataIndex);return a.depth!=null&&a.depth>=0}function ne(o,a,e,n,t){var u=t==="vertical"?"x":"y";x(o,function(d){var l,i,c;d.sort(function(r,s){return r.getLayout()[u]-s.getLayout()[u]});for(var L=0,g=d.length,p=t==="vertical"?"dx":"dy",v=0;v<g;v++)(c=L-(i=d[v]).getLayout()[u])>0&&(l=i.getLayout()[u]+c,t==="vertical"?i.setLayout({x:l},!0):i.setLayout({y:l},!0)),L=i.getLayout()[u]+i.getLayout()[p]+a;if((c=L-a-(t==="vertical"?n:e))>0)for(l=i.getLayout()[u]-c,t==="vertical"?i.setLayout({x:l},!0):i.setLayout({y:l},!0),L=l,v=g-2;v>=0;--v)(c=(i=d[v]).getLayout()[u]+i.getLayout()[p]+a-L)>0&&(l=i.getLayout()[u]-c,t==="vertical"?i.setLayout({x:l},!0):i.setLayout({y:l},!0)),L=i.getLayout()[u]})}function _e(o,a,e){x(o.slice().reverse(),function(n){x(n,function(t){if(t.outEdges.length){var u=O(t.outEdges,Be,e)/O(t.outEdges,$);if(isNaN(u)){var d=t.outEdges.length;u=d?O(t.outEdges,Fe,e)/d:0}if(e==="vertical"){var l=t.getLayout().x+(u-R(t,e))*a;t.setLayout({x:l},!0)}else{var i=t.getLayout().y+(u-R(t,e))*a;t.setLayout({y:i},!0)}}})})}function Be(o,a){return R(o.node2,a)*o.getValue()}function Fe(o,a){return R(o.node2,a)}function Xe(o,a){return R(o.node1,a)*o.getValue()}function Ye(o,a){return R(o.node1,a)}function R(o,a){return a==="vertical"?o.getLayout().x+o.getLayout().dx/2:o.getLayout().y+o.getLayout().dy/2}function $(o){return o.getValue()}function O(o,a,e){for(var n=0,t=o.length,u=-1;++u<t;){var d=+a(o[u],e);isNaN(d)||(n+=d)}return n}function Oe(o,a,e){x(o,function(n){x(n,function(t){if(t.inEdges.length){var u=O(t.inEdges,Xe,e)/O(t.inEdges,$);if(isNaN(u)){var d=t.inEdges.length;u=d?O(t.inEdges,Ye,e)/d:0}if(e==="vertical"){var l=t.getLayout().x+(u-R(t,e))*a;t.setLayout({x:l},!0)}else{var i=t.getLayout().y+(u-R(t,e))*a;t.setLayout({y:i},!0)}}})})}function Re(o){o.eachSeriesByType("sankey",function(a){var e=a.getGraph(),n=e.nodes,t=e.edges;if(n.length){var u=1/0,d=-1/0;x(n,function(l){var i=l.getLayout().value;i<u&&(u=i),i>d&&(d=i)}),x(n,function(l){var i=new ke({type:"color",mappingMethod:"linear",dataExtent:[u,d],visual:a.get("color")}).mapValueToVisual(l.getLayout().value),c=l.getModel().get(["itemStyle","color"]);c!=null?(l.setVisual("color",c),l.setVisual("style",{fill:c})):(l.setVisual("color",i),l.setVisual("style",{fill:i}))})}t.length&&x(t,function(l){var i=l.getModel().get("lineStyle");l.setVisual("style",i)})})}function qe(o){o.registerChartView(Pe),o.registerSeriesModel(ze),o.registerLayout(Ce),o.registerVisual(Re),o.registerAction({type:"dragNode",event:"dragnode",update:"update"},function(a,e){e.eachComponent({mainType:"series",subType:"sankey",query:a},function(n){n.setNodePosition(a.dataIndex,[a.localX,a.localY])})})}export{qe as install};
