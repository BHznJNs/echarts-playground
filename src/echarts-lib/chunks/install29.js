import{_ as t,cu as e,e as n,bg as i,bR as a,h as o,bM as r,bU as l,cv as p,V as s,b4 as u,bi as h,a6 as c,ch as f,D as g,bw as d,B as v,u as m,bQ as y,a0 as x,a7 as _,Q as w,aa as b,H as C,bL as O,cw as M,g as I,G as T,a5 as A,d as P}from"./index.js";import{i as G,b as U,s as z,d as E,u as N,e as $,f as k,a as D}from"./customGraphicKeyframeAnimation.js";function V(t,e){var i;return n(e,(function(e){null!=t[e]&&"auto"!==t[e]&&(i=!0)})),i}var j=["transition","enterFrom","leaveTo"],B=j.concat(["enterAnimation","updateAnimation","leaveAnimation"]);function H(t,e,n){if(n&&(!t[n]&&e[n]&&(t[n]={}),t=t[n],e=e[n]),t&&e)for(var i=n?j:B,a=0;a<i.length;a++){var o=i[a];null==t[o]&&null!=e[o]&&(t[o]=e[o])}}var K=function(a){function s(){var t=null!==a&&a.apply(this,arguments)||this;return t.type=s.type,t.preventAutoZ=!0,t}return t(s,a),s.prototype.mergeOption=function(t,e){var n=this.option.elements;this.option.elements=null,a.prototype.mergeOption.call(this,t,e),this.option.elements=n},s.prototype.optionUpdated=function(t,a){var s=this.option,u=(a?s:t).elements,h=s.elements=a?[]:s.elements,c=[];this._flatten(u,c,null);var f=e(h,c,"normalMerge"),g=this._elOptionsToUpdate=[];n(f,(function(t,e){var n=t.newOption;n&&(g.push(n),function(t,e){var n=t.existing;if(e.id=t.keyInfo.id,!e.type&&n&&(e.type=n.type),null==e.parentId){var i=e.parentOption;i?e.parentId=i.id:n&&(e.parentId=n.parentId)}e.parentOption=null}(t,n),function(t,e,n){var i=o({},n),a=t[e],s=n.$action||"merge";"merge"===s?a?(r(a,i,!0),l(a,i,{ignoreSize:!0}),p(n,a),H(n,a),H(n,a,"shape"),H(n,a,"style"),H(n,a,"extra"),n.clipPath=a.clipPath):t[e]=i:"replace"===s?t[e]=i:"remove"===s&&a&&(t[e]=null)}(h,e,n),function(t,e){if(t&&(t.hv=e.hv=[V(e,["left","right"]),V(e,["top","bottom"])],"group"===t.type)){var n=t,i=e;null==n.width&&(n.width=i.width=0),null==n.height&&(n.height=i.height=0)}}(h[e],n))}),this),s.elements=i(h,(function(t){return t&&delete t.$action,null!=t}))},s.prototype._flatten=function(t,e,i){n(t,(function(t){if(t){i&&(t.parentOption=i),e.push(t);var n=t.children;n&&n.length&&this._flatten(n,e,t),delete t.children}}),this)},s.prototype.useElOptionsToUpdate=function(){var t=this._elOptionsToUpdate;return this._elOptionsToUpdate=null,t},s.type="graphic",s.defaultOption={elements:[]},s}(a),Q={path:null,compoundPath:null,group:T,image:A,text:c},F=s(),L=function(e){function i(){var t=null!==e&&e.apply(this,arguments)||this;return t.type=i.type,t}return t(i,e),i.prototype.init=function(){this._elMap=u()},i.prototype.render=function(t,e,n){t!==this._lastGraphicModel&&this._clear(),this._lastGraphicModel=t,this._updateElements(t),this._relocate(t,n)},i.prototype._updateElements=function(t){var e=t.useElOptionsToUpdate();if(e){var i=this._elMap,a=this.group,r=t.get("z"),l=t.get("zlevel");n(e,(function(e){var p=h(e.id,null),s=null!=p?i.get(p):null,u=h(e.parentId,null),g=null!=u?i.get(u):a,d=e.type,v=e.style;"text"===d&&v&&e.hv&&e.hv[1]&&(v.textVerticalAlign=v.textBaseline=v.verticalAlign=v.align=null);var m=e.textContent,y=e.textConfig;if(v&&G(v,d,!!y,!!m)){var x=U(v,d,!0);!y&&x.textConfig&&(y=e.textConfig=x.textConfig),!m&&x.textContent&&(m=x.textContent)}var _=function(t){return t=o({},t),n(["id","parentId","$action","hv","bounding","textContent","clipPath"].concat(M),(function(e){delete t[e]})),t}(e),w=e.$action||"merge",b="merge"===w,C="replace"===w;if(b){var O=s;(j=!s)?O=S(p,g,e.type,i):(O&&(F(O).isNew=!1),z(O)),O&&(E(O,_,t,{isInit:j}),Z(O,e,r,l))}else if(C){W(s,e,i,t);var T=S(p,g,e.type,i);T&&(E(T,_,t,{isInit:!0}),Z(T,e,r,l))}else"remove"===w&&(N(s,e),W(s,e,i,t));var A=i.get(p);if(A&&m)if(b){var P=A.getTextContent();P?P.attr(m):A.setTextContent(new c(m))}else C&&A.setTextContent(new c(m));if(A){var k=e.clipPath;if(k){var D=k.type,V=void 0,j=!1;if(b){var B=A.getClipPath();V=(j=!B||F(B).type!==D)?R(D):B}else C&&(j=!0,V=R(D));A.setClipPath(V),E(V,k,t,{isInit:j}),$(V,k.keyframeAnimation,t)}var H=F(A);A.setTextConfig(y),H.option=e,function(t,e,n){var i=I(t).eventData;t.silent||t.ignore||i||(i=I(t).eventData={componentType:"graphic",componentIndex:e.componentIndex,name:t.name});i&&(i.info=n.info)}(A,t,e),f({el:A,componentModel:t,itemName:A.name,itemTooltipOption:e.tooltip}),$(A,e.keyframeAnimation,t)}}))}},i.prototype._relocate=function(t,e){for(var n=t.option.elements,i=this.group,a=this._elMap,o=e.getWidth(),r=e.getHeight(),l=["x","y"],p=0;p<n.length;p++){var s=n[p];if((x=null!=(y=h(s.id,null))?a.get(y):null)&&x.isGroup){var u=(_=x.parent)===i,c=F(x),f=F(_);c.width=g(c.option.width,u?o:f.width)||0,c.height=g(c.option.height,u?r:f.height)||0}}for(p=n.length-1;p>=0;p--){var y,x;s=n[p];if(x=null!=(y=h(s.id,null))?a.get(y):null){var _=x.parent,w=(f=F(_),_===i?{width:o,height:r}:{width:f.width,height:f.height}),b={},C=d(x,s,w,null,{hv:s.hv,boundingMode:s.bounding},b);if(!F(x).isNew&&C){for(var O=s.transition,M={},I=0;I<l.length;I++){var T=l[I],A=b[T];O&&(k(O)||v(O,T)>=0)?M[T]=A:x[T]=A}m(x,M,t,0)}else x.attr(b)}}},i.prototype._clear=function(){var t=this,e=this._elMap;e.each((function(n){W(n,F(n).option,e,t._lastGraphicModel)})),this._elMap=u()},i.prototype.dispose=function(){this._clear()},i.type="graphic",i}(y);function R(t){var e=new(x(Q,t)?Q[t]:_(t))({});return F(e).type=t,e}function S(t,e,n,i){var a=R(n);return e.add(a),i.set(t,a),F(a).id=t,F(a).isNew=!0,a}function W(t,e,n,i){t&&t.parent&&("group"===t.type&&t.traverse((function(t){W(t,e,n,i)})),D(t,e,i),n.removeKey(F(t).id))}function Z(t,e,i,a){t.isGroup||n([["cursor",b.prototype.cursor],["zlevel",a||0],["z",i||0],["z2",0]],(function(n){var i=n[0];x(e,i)?t[i]=w(e[i],n[1]):null==t[i]&&(t[i]=n[1])})),n(O(e),(function(n){if(0===n.indexOf("on")){var i=e[n];t[n]=C(i)?i:null}})),x(e,"draggable")&&(t.draggable=e.draggable),null!=e.name&&(t.name=e.name),null!=e.id&&(t.id=e.id)}function q(t){t.registerComponentModel(K),t.registerComponentView(L),t.registerPreprocessor((function(t){var e=t.graphic;P(e)?e[0]&&e[0].elements?t.graphic=[t.graphic[0]]:t.graphic=[{elements:e}]:e&&!e.elements&&(t.graphic=[{elements:[e]}])}))}export{q as install};
