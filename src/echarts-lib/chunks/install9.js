import{aL as e,_ as t,t as a,j as i,R as n,k as r,o as s,a5 as o,C as l,m as g,c as p,aM as h,S as u}from"./index.js";import{i as d}from"./CoordinateSystem.js";var c=function(){function t(){this.blurSize=30,this.pointSize=20,this.maxOpacity=1,this.minOpacity=0,this._gradientPixels={inRange:null,outOfRange:null};var t=e.createCanvas();this.canvas=t}return t.prototype.update=function(e,t,a,i,n,r){var s=this._getBrush(),o=this._getGradient(n,"inRange"),l=this._getGradient(n,"outOfRange"),g=this.pointSize+this.blurSize,p=this.canvas,h=p.getContext("2d"),u=e.length;p.width=t,p.height=a;for(var d=0;d<u;++d){var c=e[d],m=c[0],y=c[1],v=i(c[2]);h.globalAlpha=v,h.drawImage(s,m-g,y-g)}if(!p.width||!p.height)return p;for(var f=h.getImageData(0,0,p.width,p.height),S=f.data,x=0,b=S.length,O=this.minOpacity,C=this.maxOpacity-O;x<b;){v=S[x+3]/256;var _=4*Math.floor(255*v);if(v>0){var M=r(v)?o:l;v>0&&(v=v*C+O),S[x++]=M[_],S[x++]=M[_+1],S[x++]=M[_+2],S[x++]=M[_+3]*v*256}else x+=4}return h.putImageData(f,0,0),p},t.prototype._getBrush=function(){var t=this._brushCanvas||(this._brushCanvas=e.createCanvas()),a=this.pointSize+this.blurSize,i=2*a;t.width=i,t.height=i;var n=t.getContext("2d");return n.clearRect(0,0,i,i),n.shadowOffsetX=i,n.shadowBlur=this.blurSize,n.shadowColor="#000",n.beginPath(),n.arc(-a,a,this.pointSize,0,2*Math.PI,!0),n.closePath(),n.fill(),t},t.prototype._getGradient=function(e,t){for(var a=this._gradientPixels,i=a[t]||(a[t]=new Uint8ClampedArray(1024)),n=[0,0,0,0],r=0,s=0;s<256;s++)e[t](s/255,!0,n),i[r++]=n[0],i[r++]=n[1],i[r++]=n[2],i[r++]=n[3];return i},t}();function m(e){var t=e.dimensions;return"lng"===t[0]&&"lat"===t[1]}var y=function(e){function l(){var t=null!==e&&e.apply(this,arguments)||this;return t.type=l.type,t}return t(l,e),l.prototype.render=function(e,t,a){var i;t.eachComponent("visualMap",(function(t){t.eachTargetSeries((function(a){a===e&&(i=t)}))})),this._progressiveEls=null,this.group.removeAll();var n=e.coordinateSystem;"cartesian2d"===n.type||"calendar"===n.type?this._renderOnCartesianAndCalendar(e,a,0,e.getData().count()):m(n)&&this._renderOnGeo(n,e,i,a)},l.prototype.incrementalPrepareRender=function(e,t,a){this.group.removeAll()},l.prototype.incrementalRender=function(e,t,a,i){var n=t.coordinateSystem;n&&(m(n)?this.render(t,a,i):(this._progressiveEls=[],this._renderOnCartesianAndCalendar(t,i,e.start,e.end,!0)))},l.prototype.eachRendered=function(e){a(this._progressiveEls||this.group,e)},l.prototype._renderOnCartesianAndCalendar=function(e,t,a,o,l){var g,p,h,u,c=e.coordinateSystem,m=d(c,"cartesian2d");if(m){var y=c.getAxis("x"),v=c.getAxis("y");g=y.getBandWidth()+.5,p=v.getBandWidth()+.5,h=y.scale.getExtent(),u=v.scale.getExtent()}for(var f=this.group,S=e.getData(),x=e.getModel(["emphasis","itemStyle"]).getItemStyle(),b=e.getModel(["blur","itemStyle"]).getItemStyle(),O=e.getModel(["select","itemStyle"]).getItemStyle(),C=e.get(["itemStyle","borderRadius"]),_=i(e),M=e.getModel("emphasis"),w=M.get("focus"),R=M.get("blurScope"),I=M.get("disabled"),z=m?[S.mapDimension("x"),S.mapDimension("y"),S.mapDimension("value")]:[S.mapDimension("time"),S.mapDimension("value")],D=a;D<o;D++){var A=void 0,E=S.getItemVisual(D,"style");if(m){var N=S.get(z[0],D),P=S.get(z[1],D);if(isNaN(S.get(z[2],D))||isNaN(N)||isNaN(P)||N<h[0]||N>h[1]||P<u[0]||P>u[1])continue;var T=c.dataToPoint([N,P]);A=new n({shape:{x:T[0]-g/2,y:T[1]-p/2,width:g,height:p},style:E})}else{if(isNaN(S.get(z[1],D)))continue;A=new n({z2:1,shape:c.dataToRect([S.get(z[0],D)]).contentShape,style:E})}if(S.hasItemOption){var G=S.getItemModel(D),V=G.getModel("emphasis");x=V.getModel("itemStyle").getItemStyle(),b=G.getModel(["blur","itemStyle"]).getItemStyle(),O=G.getModel(["select","itemStyle"]).getItemStyle(),C=G.get(["itemStyle","borderRadius"]),w=V.get("focus"),R=V.get("blurScope"),I=V.get("disabled"),_=i(G)}A.shape.r=C;var B=e.getRawValue(D),L="-";B&&null!=B[2]&&(L=B[2]+""),r(A,_,{labelFetcher:e,labelDataIndex:D,defaultOpacity:E.opacity,defaultText:L}),A.ensureState("emphasis").style=x,A.ensureState("blur").style=b,A.ensureState("select").style=O,s(A,w,R,I),A.incremental=l,l&&(A.states.emphasis.hoverLayer=!0),f.add(A),S.setItemGraphicEl(D,A),this._progressiveEls&&this._progressiveEls.push(A)}},l.prototype._renderOnGeo=function(e,t,a,i){var n=a.targetVisuals.inRange,r=a.targetVisuals.outOfRange,s=t.getData(),l=this._hmLayer||this._hmLayer||new c;l.blurSize=t.get("blurSize"),l.pointSize=t.get("pointSize"),l.minOpacity=t.get("minOpacity"),l.maxOpacity=t.get("maxOpacity");var p=e.getViewRect().clone(),h=e.getRoamTransform();p.applyTransform(h);var u=Math.max(p.x,0),d=Math.max(p.y,0),m=Math.min(p.width+p.x,i.getWidth()),y=Math.min(p.height+p.y,i.getHeight()),v=m-u,f=y-d,S=[s.mapDimension("lng"),s.mapDimension("lat"),s.mapDimension("value")],x=s.mapArray(S,(function(t,a,i){var n=e.dataToPoint([t,a]);return n[0]-=u,n[1]-=d,n.push(i),n})),b=a.getExtent(),O="visualMap.continuous"===a.type?function(e,t){var a=e[1]-e[0];return t=[(t[0]-e[0])/a,(t[1]-e[0])/a],function(e){return e>=t[0]&&e<=t[1]}}(b,a.option.range):function(e,t,a){var i=e[1]-e[0],n=(t=g(t,(function(t){return{interval:[(t.interval[0]-e[0])/i,(t.interval[1]-e[0])/i]}}))).length,r=0;return function(e){var i;for(i=r;i<n;i++)if((s=t[i].interval)[0]<=e&&e<=s[1]){r=i;break}if(i===n)for(i=r-1;i>=0;i--){var s;if((s=t[i].interval)[0]<=e&&e<=s[1]){r=i;break}}return i>=0&&i<n&&a[i]}}(b,a.getPieceList(),a.option.selected);l.update(x,v,f,n.color.getNormalizer(),{inRange:n.color.getColorMapper(),outOfRange:r.color.getColorMapper()},O);var C=new o({style:{width:v,height:f,x:u,y:d,image:l.canvas},silent:!0});this.group.add(C)},l.type="heatmap",l}(l),v=function(e){function a(){var t=null!==e&&e.apply(this,arguments)||this;return t.type=a.type,t}return t(a,e),a.prototype.getInitialData=function(e,t){return p(null,this,{generateCoord:"value"})},a.prototype.preventIncremental=function(){var e=h.get(this.get("coordinateSystem"));if(e&&e.dimensions)return"lng"===e.dimensions[0]&&"lat"===e.dimensions[1]},a.type="series.heatmap",a.dependencies=["grid","geo","calendar"],a.defaultOption={coordinateSystem:"cartesian2d",z:2,geoIndex:0,blurSize:30,pointSize:20,maxOpacity:1,minOpacity:0,select:{itemStyle:{borderColor:"#212121"}}},a}(u);function f(e){e.registerChartView(y),e.registerSeriesModel(v)}export{f as install};
